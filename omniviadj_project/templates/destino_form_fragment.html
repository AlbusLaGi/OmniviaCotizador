<form method="post" action="{% url 'destino-update' pk=object.pk %}">
    {% csrf_token %}

    <div class="mb-3">
        <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}</label>
        {{ form.nombre }}
        {% for error in form.nombre.errors %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        <label for="{{ form.ubicacion.id_for_label }}" class="form-label">{{ form.ubicacion.label }}</label>
        {{ form.ubicacion }}
        {% for error in form.ubicacion.errors %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        <label for="{{ form.descripcion.id_for_label }}" class="form-label">{{ form.descripcion.label }}</label>
        {{ form.descripcion }}
        {% for error in form.descripcion.errors %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        <label for="{{ form.categoria.id_for_label }}" class="form-label">{{ form.categoria.label }}</label>
        {{ form.categoria }}
        {% for error in form.categoria.errors %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endfor %}
    </div>

    {% if form.categoria_otro %}
    <div class="mb-3" id="categoria-otro-container" style="display: none;">
        <label for="{{ form.categoria_otro.id_for_label }}" class="form-label">{{ form.categoria_otro.label }}</label>
        {{ form.categoria_otro }}
        {% for error in form.categoria_otro.errors %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="mb-3">
        <label for="{{ form.imagenes_texto.id_for_label }}" class="form-label">{{ form.imagenes_texto.label }}</label>
        {{ form.imagenes_texto }}
        <small class="form-text">Ingrese las URLs de las imágenes separadas por comas</small>
        {% for error in form.imagenes_texto.errors %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        <h5>{{ form.actividades.label }}</h5>
        <small class="form-text">
            Añada aquí todos los atractivos, entradas a museos, parques o cualquier sitio que tenga y no tenga costo. Si no tiene precio, deje '0'. Si el precio es el mismo para todas las temporadas, ingréselo en cada campo correspondiente. En el momento de generar la cotización, tendrás la opción de seleccionar y modificar cada uno de estos ítems.<br>
            <strong>Recomendación de precios:</strong> Ingrese los números sin puntos de separación. Por ejemplo: $32.000 debe ser 32000; $35.500,09 debe ser 35500.09. <br>
            <strong><u>No incluir hoteles, restaurantes, transporte o seguros.</u></strong>
        </small>
        <div id="atractivos-container" class="mt-3">
            <!-- Dynamic attraction cards will be inserted here -->
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-atractivo-btn">
            <i class="fas fa-plus"></i> Agregar Atractivo
        </button>
        {{ form.actividades.as_hidden }}
        {% for error in form.actividades.errors %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary">Actualizar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
    </div>
</form>

<!-- Template for a new attraction card -->
<template id="atractivo-template">
    <div class="card mb-3 atractivo-card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <input type="text" class="form-control atractivo-nombre" placeholder="Nombre del Atractivo">
                </div>
                <div class="col-md-4">
                    <select class="form-select tipo-costo-atractivo">
                        <option value="Libre">Libre</option>
                        <option value="Con Costo" selected>Con Costo</option>
                    </select>
                </div>
                <div class="col-md-2 text-end">
                    <button type="button" class="btn btn-danger btn-sm remove-atractivo-btn"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
        </div>
        <div class="card-body precios-section">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Descripción de Tarifa</th>
                            <th>Precio T. Alta</th>
                            <th>Precio T. Media</th>
                            <th>Precio T. Baja</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody class="precios-container">
                        <!-- Dynamic price rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm add-precio-btn"><i class="fas fa-plus"></i> Agregar Tarifa</button>
        </div>
    </div>
</template>

<!-- Template for a new price row -->
<template id="precio-template">
    <tr class="precio-row">
        <td><input type="text" class="form-control precio-categoria" placeholder="Ej: Adultos, Niños"></td>
        <td><input type="text" class="form-control price-input precio-alta" placeholder="0"></td>
        <td><input type="text" class="form-control price-input precio-media" placeholder="0"></td>
        <td><input type="text" class="form-control price-input precio-baja" placeholder="0"></td>
        <td><button type="button" class="btn btn-danger btn-sm remove-precio-btn"><i class="fas fa-times"></i></button></td>
    </tr>
</template>


<script>
// Lógica para el campo "Otro" categoría
document.addEventListener('DOMContentLoaded', function() {
    const categoriaSelect = document.getElementById('{{ form.categoria.id_for_label }}');
    const categoriaOtroContainer = document.getElementById('categoria-otro-container');

    function toggleCategoriaOtro() {
        if (categoriaSelect && categoriaOtroContainer) {
            if (categoriaSelect.value === 'Otro') {
                categoriaOtroContainer.style.display = 'block';
            } else {
                categoriaOtroContainer.style.display = 'none';
            }
        }
    }

    if (categoriaSelect) {
        toggleCategoriaOtro();
        categoriaSelect.addEventListener('change', toggleCategoriaOtro);
    }
});

// Lógica para manejar atractivos dinámicos similar a la del formulario principal
document.addEventListener('DOMContentLoaded', function() {
    const atractivosContainer = document.getElementById('atractivos-container');
    const addAtractivoBtn = document.getElementById('add-atractivo-btn');
    const hiddenAtractivosInput = document.getElementById('{{ form.actividades.id_for_label }}');
    const atractivoTemplate = document.getElementById('atractivo-template');
    const precioTemplate = document.getElementById('precio-template');

    // Cargar atractivos existentes si estamos editando
    if (hiddenAtractivosInput.value) {
        try {
            const atractivosExistentes = JSON.parse(hiddenAtractivosInput.value);
            if (Array.isArray(atractivosExistentes)) {
                atractivosExistentes.forEach(actividad => {
                    const clone = atractivoTemplate.content.cloneNode(true);
                    // Configurar valores del atractivo
                    const nombreInput = clone.querySelector('.atractivo-nombre');
                    const tipoCostoSelect = clone.querySelector('.tipo-costo-atractivo');
                    const preciosSection = clone.querySelector('.precios-section');

                    nombreInput.value = actividad.atractivo_nombre || '';
                    tipoCostoSelect.value = actividad.tipo_costo || 'Libre';

                    // Mostrar u ocultar sección de precios según tipo de costo
                    if (actividad.tipo_costo === 'Libre') {
                        preciosSection.style.display = 'none';
                    } else {
                        preciosSection.style.display = 'block';
                    }

                    // Agregar precios si existen
                    if (Array.isArray(actividad.precios)) {
                        const preciosContainer = clone.querySelector('.precios-container');
                        actividad.precios.forEach(precio => {
                            const precioClone = precioTemplate.content.cloneNode(true);
                            const categoriaInput = precioClone.querySelector('.precio-categoria');
                            const altaInput = precioClone.querySelector('.precio-alta');
                            const mediaInput = precioClone.querySelector('.precio-media');
                            const bajaInput = precioClone.querySelector('.precio-baja');

                            categoriaInput.value = precio.categoria || '';
                            altaInput.value = precio.temporada_alta || '';
                            mediaInput.value = precio.temporada_media || '';
                            bajaInput.value = precio.temporada_baja || '';

                            preciosContainer.appendChild(precioClone);
                        });
                    }

                    atractivosContainer.appendChild(clone);
                });
            }
        } catch (e) {
            console.error('Error al parsear atractivos existentes:', e);
        }
    }

    addAtractivoBtn.addEventListener('click', function() {
        const clone = atractivoTemplate.content.cloneNode(true);
        atractivosContainer.appendChild(clone);
    });

    atractivosContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-atractivo-btn')) {
            e.target.closest('.atractivo-card').remove();
        }
        if (e.target.closest('.add-precio-btn')) {
            const preciosContainer = e.target.closest('.card-body').querySelector('.precios-container');
            const clone = precioTemplate.content.cloneNode(true);
            preciosContainer.appendChild(clone);
        }
        if (e.target.closest('.remove-precio-btn')) {
            e.target.closest('.precio-row').remove();
        }
    });

    atractivosContainer.addEventListener('change', function(e) {
        if (e.target.classList.contains('tipo-costo-atractivo')) {
            const card = e.target.closest('.atractivo-card');
            const preciosSection = card.querySelector('.precios-section');
            if (e.target.value === 'Con Costo') {
                preciosSection.style.display = 'block';
            } else {
                preciosSection.style.display = 'none';
            }
        }
    });

    // Serializar los atractivos antes de enviar el formulario
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            // Serializar atractivos activos
            const atractivosData = [];
            atractivosContainer.querySelectorAll('.atractivo-card').forEach(card => {
                const nombreAtractivo = card.querySelector('.atractivo-nombre').value;
                const tipoCosto = card.querySelector('.tipo-costo-atractivo').value;

                if (nombreAtractivo) {
                    let preciosData = [];
                    if (tipoCosto === 'Con Costo') {
                        card.querySelectorAll('.precio-row').forEach(row => {
                            const categoria = row.querySelector('.precio-categoria').value;
                            const alta = row.querySelector('.precio-alta').value;
                            const media = row.querySelector('.precio-media').value;
                            const baja = row.querySelector('.precio-baja').value;
                            if (categoria) {
                                preciosData.push({
                                    categoria: categoria,
                                    temporada_alta: alta,
                                    temporada_media: media,
                                    temporada_baja: baja
                                });
                            }
                        });
                    }
                    atractivosData.push({
                        atractivo_nombre: nombreAtractivo,
                        tipo_costo: tipoCosto,
                        precios: preciosData
                    });
                }
            });
            hiddenAtractivosInput.value = JSON.stringify(atractivosData);
        });
    }
});
</script>