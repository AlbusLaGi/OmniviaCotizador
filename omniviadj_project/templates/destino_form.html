{% extends 'base.html' %}

{% block title %}Ingresar Nuevo Destino{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="profile-card glass-effect">
                <h2 class="card-title text-center mb-4">{% if object %}Editar Destino{% else %}Ingresar Nuevo Destino{% endif %}</h2>

                <!-- Visualización de imágenes existentes al comienzo del formulario -->
                {% if object and object.imagenes %}
                <div class="mb-4">
                    <h5>Imágenes existentes:</h5>
                    <div class="row">
                    {% for imagen_url in object.imagenes %}
                        {% if imagen_url %}
                        <div class="col-md-3 col-sm-4 col-6 mb-2">
                            <img src="{{ imagen_url }}" alt="Imagen existente" class="img-thumbnail img-fluid" style="max-height: 120px; object-fit: cover;">
                        </div>
                        {% endif %}
                    {% endfor %}
                    </div>
                </div>
                {% endif %}

                <form method="post" id="destinoForm">
                    {% csrf_token %}
                    <div id="form-errors" class="alert alert-danger" style="display: none;"></div>
        
        <div class="mb-3">
            <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}</label>
            {{ form.nombre }}
            <div class="invalid-feedback"></div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="{{ form.pais.id_for_label }}" class="form-label">{{ form.pais.label }}</label>
                {{ form.pais }}
                <div class="invalid-feedback"></div>
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.departamento.id_for_label }}" class="form-label">{{ form.departamento.label }}</label>
                {{ form.departamento }}
                <div class="invalid-feedback"></div>
            </div>
            <div class="col-md-4 mb-3">
                <label for="{{ form.municipio.id_for_label }}" class="form-label">{{ form.municipio.label }}</label>
                {{ form.municipio }}
                <div class="invalid-feedback"></div>
            </div>
        </div>

        <div class="mb-3">
            <label for="{{ form.ubicacion.id_for_label }}" class="form-label">{{ form.ubicacion.label }}</label>
            {{ form.ubicacion }}
            <small class="form-field-note">Opcional. Dejar en blanco si los campos anteriores cubren la ubicación.</small>
            <div class="invalid-feedback"></div>
        </div>

        <div class="mb-3">
            <label for="{{ form.descripcion.id_for_label }}" class="form-label">{{ form.descripcion.label }}</label>
            {{ form.descripcion }}
            <small class="form-field-note">Ej: Un destino histórico frente al mar con murallas, calles coloridas y balcones floridos, perfecto para paseos románticos, recorridos culturales y disfrutar atardeceres junto al Caribe. Además, sus zonas insulares como Barú y las Islas del Rosario ofrecen playas de arena blanca y aguas cristalinas ideales para descansar y practicar deportes acuáticos.</small>
            <div class="invalid-feedback"></div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.categoria.id_for_label }}" class="form-label">{{ form.categoria.label }}</label>
                {{ form.categoria }}
                <div class="invalid-feedback"></div>
            </div>
            <div class="col-md-6 mb-3" id="otroCategoriaWrapper" style="display: none;">
                <label for="{{ form.categoria_otro.id_for_label }}" class="form-label">{{ form.categoria_otro.label }}</label>
                {{ form.categoria_otro }}
                <div class="invalid-feedback"></div>
            </div>
        </div>

        <hr>

        <div class="mb-3">
            <h5>Atractivos y Puntos de Interés</h5>
            <small class="form-field-note">
                Añada aquí todos los atractivos, entradas a museos, parques o cualquier sitio que tenga y no tenga costo. Si no tiene precio, deje '0'. Si el precio es el mismo para todas las temporadas, ingréselo en cada campo correspondiente. En el momento de generar la cotización, tendrás la opción de seleccionar y modificar cada uno de estos ítems.<br>
                <strong>Recomendación de precios:</strong> Ingrese los números sin puntos de separación. Por ejemplo: $32.000 debe ser 32000; $35.500,09 debe ser 35500.09. <br>
                <strong><u>No incluir hoteles, restaurantes, transporte o seguros.</u></strong>
            </small>
            <div id="atractivos-container" class="mt-3">
                <!-- Dynamic attraction cards will be inserted here -->
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-atractivo-btn">
                <i class="fas fa-plus"></i> Agregar Atractivo y Punto de Interés
            </button>
            {{ form.actividades.as_hidden }}
            <div class="invalid-feedback"></div>
        </div>

        <hr>

        <div class="mb-3">
            <label for="{{ form.imagenes_texto.id_for_label }}" class="form-label">{{ form.imagenes_texto.label }}</label>
            {{ form.imagenes_texto }}
            <small class="form-field-note">Ingrese las URLs de las imágenes separadas por comas. Ej: https://ejemplo.com/img1.jpg, https://ejemplo.com/img2.png <a href="https://youtu.be/xR39NzO3Krg?si=-YNm45o7ZNI9aY8K" target="_blank">'tutorial aqui'</a></small>
            <div class="invalid-feedback"></div>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">{% if object %}Actualizar{% else %}Guardar{% endif %}</button>
            {% if object %}
            <a href="{% url 'destino-delete' pk=object.pk %}" class="btn btn-danger" onclick="return confirm('¿Está seguro de que desea eliminar este destino? Esta acción no se puede deshacer.')">Eliminar</a>
            {% endif %}
            <a href="{% url 'data_entry' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
</div>
</div>
</div>

<!-- Template for a new attraction card -->
<template id="atractivo-template">
    <div class="card mb-3 atractivo-card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <input type="text" class="form-control atractivo-nombre" placeholder="Nombre del Atractivo">
                </div>
                <div class="col-md-3">
                    <select class="form-select tipo-costo-atractivo">
                        <option value="Libre">Libre</option>
                        <option value="Con Costo" selected>Con Costo</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select tipo-asignacion-atractivo">
                        <option value="">-- Seleccione tipo --</option>
                        <option value="visita">Visita</option>
                        <option value="entrada">Entrada</option>
                    </select>
                </div>
                <div class="col-md-2 text-end">
                    <button type="button" class="btn btn-danger btn-sm remove-atractivo-btn"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
        </div>
        <div class="card-body precios-section">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Descripción de Tarifa</th>
                            <th>Precio T. Alta</th>
                            <th>Precio T. Media</th>
                            <th>Precio T. Baja</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody class="precios-container">
                        <!-- Dynamic price rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm add-precio-btn"><i class="fas fa-plus"></i> Agregar Tarifa</button>
        </div>
    </div>
</template>

<!-- Template for a new price row -->
<template id="precio-template">
    <tr class="precio-row">
        <td><input type="text" class="form-control precio-categoria" placeholder="Ej: Adultos, Niños"></td>
        <td><input type="text" class="form-control price-input precio-alta" placeholder="0"></td>
        <td><input type="text" class="form-control price-input precio-media" placeholder="0"></td>
        <td><input type="text" class="form-control price-input precio-baja" placeholder="0"></td>
        <td><button type="button" class="btn btn-danger btn-sm remove-precio-btn"><i class="fas fa-times"></i></button></td>
    </tr>
</template>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Logic for 'Otro' Categoria
    const categoriaSelect = document.getElementById('{{ form.categoria.id_for_label }}');
    const otroCategoriaWrapper = document.getElementById('otroCategoriaWrapper');
    function toggleOtroCategoria() {
        if (categoriaSelect.value === 'Otro') {
            otroCategoriaWrapper.style.display = 'block';
        } else {
            otroCategoriaWrapper.style.display = 'none';
        }
    }
    if (categoriaSelect) {
        toggleOtroCategoria();
        categoriaSelect.addEventListener('change', toggleOtroCategoria);
    }

    // --- Logic for dynamic 'Atractivos y Costos' ---
    const atractivosContainer = document.getElementById('atractivos-container');
    const addAtractivoBtn = document.getElementById('add-atractivo-btn');
    const hiddenAtractivosInput = document.getElementById('{{ form.actividades.id_for_label }}');
    const atractivoTemplate = document.getElementById('atractivo-template');
    const precioTemplate = document.getElementById('precio-template');

    // Cargar atractivos existentes si estamos editando
    if (hiddenAtractivosInput.value) {
        try {
            const atractivosExistentes = JSON.parse(hiddenAtractivosInput.value);
            if (Array.isArray(atractivosExistentes)) {
                atractivosExistentes.forEach(actividad => {
                    const clone = atractivoTemplate.content.cloneNode(true);
                    // Configurar valores del atractivo
                    const nombreInput = clone.querySelector('.atractivo-nombre');
                    const tipoCostoSelect = clone.querySelector('.tipo-costo-atractivo');
                    const tipoAsignacionSelect = clone.querySelector('.tipo-asignacion-atractivo');
                    const preciosSection = clone.querySelector('.precios-section');

                    nombreInput.value = actividad.atractivo_nombre || '';
                    tipoCostoSelect.value = actividad.tipo_costo || 'Libre';
                    tipoAsignacionSelect.value = actividad.tipo_asignacion || ''; // Agregar tipo de asignación si existe

                    // Mostrar u ocultar sección de precios según tipo de costo
                    if (actividad.tipo_costo === 'Libre') {
                        preciosSection.style.display = 'none';
                    } else {
                        preciosSection.style.display = 'block';
                    }

                    // Agregar precios si existen
                    if (Array.isArray(actividad.precios)) {
                        const preciosContainer = clone.querySelector('.precios-container');
                        actividad.precios.forEach(precio => {
                            const precioClone = precioTemplate.content.cloneNode(true);
                            const categoriaInput = precioClone.querySelector('.precio-categoria');
                            const altaInput = precioClone.querySelector('.precio-alta');
                            const mediaInput = precioClone.querySelector('.precio-media');
                            const bajaInput = precioClone.querySelector('.precio-baja');

                            categoriaInput.value = precio.categoria || '';
                            altaInput.value = precio.temporada_alta || '';
                            mediaInput.value = precio.temporada_media || '';
                            bajaInput.value = precio.temporada_baja || '';

                            preciosContainer.appendChild(precioClone);
                        });
                    }

                    atractivosContainer.appendChild(clone);
                });
            }
        } catch (e) {
            console.error('Error al parsear atractivos existentes:', e);
        }
    }

    addAtractivoBtn.addEventListener('click', function() {
        const clone = atractivoTemplate.content.cloneNode(true);
        atractivosContainer.appendChild(clone);
    });

    atractivosContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-atractivo-btn')) {
            e.target.closest('.atractivo-card').remove();
        }
        if (e.target.closest('.add-precio-btn')) {
            const preciosContainer = e.target.closest('.card-body').querySelector('.precios-container');
            const clone = precioTemplate.content.cloneNode(true);
            preciosContainer.appendChild(clone);
        }
        if (e.target.closest('.remove-precio-btn')) {
            e.target.closest('.precio-row').remove();
        }
    });

    atractivosContainer.addEventListener('change', function(e) {
        if (e.target.classList.contains('tipo-costo-atractivo')) {
            const card = e.target.closest('.atractivo-card');
            const preciosSection = card.querySelector('.precios-section');
            if (e.target.value === 'Con Costo') {
                preciosSection.style.display = 'block';
            } else {
                preciosSection.style.display = 'none';
            }
        }
    });

    // --- Update hidden imagenes field when text field changes ---
    const imagenesTextoInput = document.getElementById('{{ form.imagenes_texto.id_for_label }}');
    if (imagenesTextoInput) {
        // Update immediately when the field changes
        imagenesTextoInput.addEventListener('input', updateImagenesHiddenField);

        // Also call it on page load after DOM is ready
        updateImagenesHiddenField();
    }

    function updateImagenesHiddenField() {
        const imagenesTexto = document.getElementById('{{ form.imagenes_texto.id_for_label }}');
        if (imagenesTexto) {
            const imagenesArray = imagenesTexto.value.split(',')
                .map(url => url.trim())
                .filter(url => url.length > 0);

            // Buscar el campo oculto de imágenes de forma segura
            const imagenesInput = document.querySelector('input[name="imagenes"]');
            if (imagenesInput) {
                imagenesInput.value = JSON.stringify(imagenesArray);
                console.log('Imágenes actualizadas en campo oculto:', imagenesArray); // Para depuración
            } else {
                console.warn('No se encontró el campo oculto de imágenes');
            }
        }
    }

    // --- AJAX Form Submission ---
    const destinoForm = document.getElementById('destinoForm');
    destinoForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // Asegurar que el campo de imágenes esté actualizado antes de enviar
        updateImagenesHiddenField();

        // --- Serialize Atractivos Data ---
        const atractivosData = [];
        atractivosContainer.querySelectorAll('.atractivo-card').forEach(card => {
            const nombreAtractivo = card.querySelector('.atractivo-nombre').value;
            const tipoCosto = card.querySelector('.tipo-costo-atractivo').value;
            const tipoAsignacion = card.querySelector('.tipo-asignacion-atractivo').value;

            if (nombreAtractivo) {
                let preciosData = [];
                if (tipoCosto === 'Con Costo') {
                    card.querySelectorAll('.precio-row').forEach(row => {
                        const categoria = row.querySelector('.precio-categoria').value;
                        const alta = row.querySelector('.precio-alta').value;
                        const media = row.querySelector('.precio-media').value;
                        const baja = row.querySelector('.precio-baja').value;
                        if (categoria) {
                            preciosData.push({
                                categoria: categoria,
                                temporada_alta: alta, // Keep as string for now
                                temporada_media: media,
                                temporada_baja: baja
                            });
                        }
                    });
                }
                atractivosData.push({
                    atractivo_nombre: nombreAtractivo,
                    tipo_costo: tipoCosto,
                    tipo_asignacion: tipoAsignacion, // Agregar tipo de asignación
                    precios: preciosData
                });
            }
        });
        hiddenAtractivosInput.value = JSON.stringify(atractivosData);
        
        // --- Prepare FormData for Fetch ---
        const formData = new FormData(destinoForm);
        const errorDiv = document.getElementById('form-errors');

        // Clear previous errors
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        document.querySelectorAll('#destinoForm .invalid-feedback').forEach(el => el.textContent = '');
        document.querySelectorAll('#destinoForm .is-invalid').forEach(el => el.classList.remove('is-invalid'));

        // Actualizar el valor de imágenes en el formData con el valor procesado
        const imagenesTextoInput = document.getElementById('{{ form.imagenes_texto.id_for_label }}');
        if (imagenesTextoInput) {
            const imagenesArray = imagenesTextoInput.value.split(',')
                .map(url => url.trim())
                .filter(url => url.length > 0);
            const imagenesJson = JSON.stringify(imagenesArray);
            // Eliminar el valor anterior y agregar el nuevo
            formData.delete('imagenes');
            formData.append('imagenes', imagenesJson);
        }

        fetch(destinoForm.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const confirmationModal = new bootstrap.Modal(document.getElementById('actionConfirmationModal'));
                const modalTitle = document.getElementById('actionConfirmationModalLabel');
                const modalBody = document.getElementById('actionConfirmationModalBody');
                const primaryBtn = document.getElementById('actionConfirmationPrimaryBtn');
                const secondaryBtn = document.getElementById('actionConfirmationSecondaryBtn');

                modalTitle.textContent = 'Éxito';
                modalBody.textContent = data.message;
                
                primaryBtn.textContent = 'Continuar';
                secondaryBtn.textContent = 'Agregar Nuevo Destino';

                primaryBtn.onclick = () => { window.location.href = "{% url 'dashboard' %}"; };
                secondaryBtn.onclick = () => { 
                    destinoForm.reset();
                    atractivosContainer.innerHTML = ''; // Clear dynamic fields
                    confirmationModal.hide();
                };

                confirmationModal.show();
            } else {
                // Handle form errors
                for (const fieldName in data.errors) {
                    const fieldElement = document.getElementById(`id_${fieldName}`);
                    if (fieldElement) {
                        fieldElement.classList.add('is-invalid');
                        const errorFeedback = fieldElement.closest('.mb-3').querySelector('.invalid-feedback');
                        if (errorFeedback) {
                            errorFeedback.textContent = data.errors[fieldName].join(' ');
                        }
                    }
                }
                if (data.errors.__all__) {
                    errorDiv.textContent = data.errors.__all__.join(' ');
                    errorDiv.style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = 'Ocurrió un error inesperado. Por favor, intente de nuevo.';
            errorDiv.style.display = 'block';
        });
    });
});
</script>
{% endblock %}
